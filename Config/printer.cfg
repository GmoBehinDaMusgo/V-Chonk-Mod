#############################################################################################################
### CONFIGURATION GENERATED BY THE RATOS CONFIGURATOR
#############################################################################################################

[include SHT36_V3.cfg]
[include homing.cfg]
[include homing.cfg]
[include mainsail.cfg]
[include eddypz.cfg]

#############################################################################################################
### MACRO CONFIGURATION
### Configure the behavior of RatOS macros
### See: https://os.ratrig.com/docs/configuration/macros
#############################################################################################################


#############################################################################################################
### USER OVERRIDES & CUSTOM CONFIGURATION
### Anything custom you want to add, or RatOS configuration you want to override, do it here.
### This section is pre-populated with the most common settings you may want to change.
### See: https://os.ratrig.com/docs/configuration/includes-and-overrides
###
### It is recommended that you follow these steps to properly calibrate your printer:
### 0) Sanity check and PID Tuning: https://www.klipper3d.org/Config_checks.html
### 1) Z-offset calibration: Follow along from step 6 in the official beacon guide
###    https://docs.beacon3d.com/quickstart/#6-calibrate-beacon
### 2) Pressure Advance: https://www.klipper3d.org/Pressure_Advance.html
### 3) Skew Correction: https://www.klipper3d.org/Skew_Correction.html
### 4) Resonance Compensation: https://www.klipper3d.org/Resonance_Compensation.html
### RatOS has dedicated macro's to generate shaper graphs for deeper analysis (requires accelerometer).
### Use MEASURE_COREXY_BELT_TENSION to compare tension between belts, and use
### GENERATE_SHAPER_GRAPHS to generate the resonance graphs for analysing and manually entering input shaper
### configuration.
### You can run SHAPER_CALIBRATE to automatically calibrate your input shaper configuration, if you just want
### to get started.
### Additionally, you can use the Realtime Analysis Tool to analyze your printer's performance in real-time.
### Read more about klipper here: https://www.klipper3d.org/Overview.html
#############################################################################################################

#############################################################################################################
### CONTROLBOARD & TOOLBOARD
#############################################################################################################
[include RatOS/boards/rpi/config.cfg]

[force_move]
enable_force_move: True

[board_pins btt-skr-2-407]
aliases:
	#----------------------------------------------- X motor pins -----------------------------------------------
	# Assigned to slot: "X"
	#------------------------------------------------------------------------------------------------------------
	x_step_pin=PE2,
	x_dir_pin=PE1,
	x_enable_pin=PE3,
	x_uart_pin=PE0,
	x_diag_pin=PC1,
	x_endstop_pin=PC1,
	#----------------------------------------------- Y motor pins -----------------------------------------------
	# Assigned to slot: "Y"
	#------------------------------------------------------------------------------------------------------------
	y_step_pin=PD5,
	y_dir_pin=PD4,
	y_enable_pin=PD6,
	y_uart_pin=PD3,
	y_diag_pin=PC3,
	y_endstop_pin=PC3,
	#----------------------------------------------- Z motor pins -----------------------------------------------
	# Assigned to slot: "Z"
	#------------------------------------------------------------------------------------------------------------
	z0_step_pin=PA15,
	z0_dir_pin=PA8,
	z0_enable_pin=PD1,
	z0_uart_pin=PD0,
	z0_diag_pin=PC0,
	#---------------------------------------------- Z1 motor pins -----------------------------------------------
	# Assigned to slot: "E0"
	#------------------------------------------------------------------------------------------------------------
	z1_step_pin=PD15,
	z1_dir_pin=PD14,
	z1_enable_pin=PC7,
	z1_uart_pin=PC6,
	z1_diag_pin=PC2,
	#------------------------------------------- EXTRUDER motor pins --------------------------------------------
	# Assigned to slot: "E1"
	#------------------------------------------------------------------------------------------------------------
	e_step_pin=PD11,
	e_dir_pin=PD10,
	e_enable_pin=PD13,
	e_uart_pin=PD12,
	e_diag_pin=PA0,
	#----------------------------------------------- GENERAL PINS -----------------------------------------------
	e_heater_pin=PB3,
	e_sensor_pin=PA2,
	stepper_spi_mosi_pin=null,
	stepper_spi_miso_pin=null,
	stepper_spi_sclk_pin=null,
	adxl345_cs_pin=PB12,
	bltouch_sensor_pin=PE4,
	bltouch_control_pin=PE5,
	probe_pin=PE4,
	fan_part_cooling_pin=PB7,
	fan_toolhead_cooling_pin=PB6,
	fan_controller_board_pin=PB5,
	heater_bed_heating_pin=PD7,
	heater_bed_sensor_pin=PA1,
	4p_fan_part_cooling_pin=null,
	4p_fan_part_cooling_tach_pin=null,
	4p_toolhead_cooling_pin=null,
	4p_toolhead_cooling_tach_pin=null,
	4p_controller_board_pin=null,
	4p_controller_board_tach_pin=null

[mcu]
serial: /dev/serial/by-path/platform-fd500000.pcie-pci-0000:01:00.0-usb-0:1.3:1.0
#/dev/RatOS/btt-skr-2-407

[temperature_sensor SKR_2_407]
sensor_type: temperature_mcu

[output_pin Motor_Power]
pin: PC13
value: 1

[printer]
kinematics: corexy
max_velocity: 500
max_accel: 10000
minimum_cruise_ratio: 0.5
max_z_velocity: 10
max_z_accel: 50
square_corner_velocity: 5

#---------------------------------------------------- X -----------------------------------------------------
# The A axis motor for the toolhead, located at the rear left of the printer
#------------------------------------------------------------------------------------------------------------
[stepper_x]
step_pin: PE2
dir_pin: !PE1
enable_pin: !PE3
microsteps: 64
full_steps_per_rotation: 200
rotation_distance: 40
endstop_pin: tmc2209_stepper_x:virtual_endstop
homing_retract_dist: 0
homing_speed: 30
position_max: 181
position_min: -3
position_endstop: -3

[tmc2209 stepper_x]
stealthchop_threshold: 0
interpolate: False
uart_pin: PE0
diag_pin: ^PC1
driver_SGTHRS: 70 # Lower value = lower sensitivity, range 0 to 255
run_current: 1.0
driver_TBL: 1
driver_TOFF: 3
driver_HEND: 0
driver_HSTRT: 0
sense_resistor: 0.11

#---------------------------------------------------- Y -----------------------------------------------------
# The B axis motor for the toolhead, located at the rear right of the printer
#------------------------------------------------------------------------------------------------------------
[stepper_y]
step_pin: PD5
dir_pin: !PD4
enable_pin: !PD6
microsteps: 64
full_steps_per_rotation: 200
rotation_distance: 40
endstop_pin: tmc2209_stepper_y:virtual_endstop
homing_retract_dist: 0
homing_speed: 30
position_max: 194
position_min: -18
position_endstop: -18

[tmc2209 stepper_y]
stealthchop_threshold: 0
interpolate: False
uart_pin: PD3
diag_pin: ^PC3
driver_SGTHRS: 75 # Lower value = lower sensitivity, range 0 to 255
run_current: 1.0
driver_TBL: 1
driver_TOFF: 3
driver_HEND: 0
driver_HSTRT: 0
sense_resistor: 0.11

#---------------------------------------------------- Z -----------------------------------------------------
# The front right Z motors for the kinematic bed
#------------------------------------------------------------------------------------------------------------

[stepper_z]
step_pin: PA15
dir_pin: !PA8
enable_pin: !PD1
microsteps: 64
full_steps_per_rotation: 400
rotation_distance: 4
endstop_pin: probe:z_virtual_endstop
homing_speed: 10
position_min: -5
position_max: 180
second_homing_speed: 3
homing_retract_dist: 3

[tmc2209 stepper_z]
stealthchop_threshold: 0
interpolate: False
uart_pin: PD0
run_current: 0.85
driver_TBL: 1
driver_TOFF: 3
driver_HEND: 2
driver_HSTRT: 0
sense_resistor: 0.11

#---------------------------------------------------- Z1 ----------------------------------------------------
# The front left Z motors for the kinematic bed
#------------------------------------------------------------------------------------------------------------
[stepper_z1]
step_pin: PD15
dir_pin: !PD14
enable_pin: !PC7
microsteps: 64
full_steps_per_rotation: 400
rotation_distance: 4

[tmc2209 stepper_z1]
stealthchop_threshold: 0
interpolate: False
uart_pin: PC6
run_current: 0.85
driver_TBL: 1
driver_TOFF: 3
driver_HEND: 2
driver_HSTRT: 0
sense_resistor: 0.11

#---------------------------------------------------- Z2 ----------------------------------------------------
# The rear Z motor for the kinematic bed
#------------------------------------------------------------------------------------------------------------

[stepper_z2]
step_pin: PD11
dir_pin: !PD10
enable_pin: !PD13
microsteps: 64
full_steps_per_rotation: 400
rotation_distance: 4

[tmc2209 stepper_z2]
stealthchop_threshold: 0
interpolate: False
uart_pin: PD12
run_current: 0.85
driver_TBL: 1
driver_TOFF: 3
driver_HEND: 2
driver_HSTRT: 0
sense_resistor: 0.11

#---------------------------------------------------- Extruder ----------------------------------------------------
# Extruder
#------------------------------------------------------------------------------------------------------------

[extruder]
control: pid
pid_Kp: 22.2
pid_Ki: 1.08
pid_Kd: 114

#---------------------------------------------------- Heater bed ----------------------------------------------------
# Heater bed
#------------------------------------------------------------------------------------------------------------

[heater_bed]
heater_pin: PD7 
sensor_type: NTC 100K MGB18-104F39050L32
sensor_pin: PA1
max_power: 1
min_temp: 0
max_temp: 120
control: pid
pid_Kp: 22.2
pid_Ki: 1.08
pid_Kd: 114

[bed_mesh]
speed: 150
horizontal_move_z: 2
mesh_min: 10,10
mesh_max: 170,170
probe_count: 9, 9
algorithm: bicubic

[z_tilt]
##  Use Z_TILT_ADJUST to level the bed .
##  z_positions: Location of toolhead
z_positions:
    89, -38
    -41, 167
    218, 167
points:
    89, 35
    15, 190
    165, 190
speed: 150
horizontal_move_z: 5
retries: 5
retry_tolerance: 0.05

#---------------------------------------------------- Probe ----------------------------------------------------
# Probe
#------------------------------------------------------------------------------------------------------------

[probe_eddy_current fly_eddy_probe]
#z_offset: 2

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [probe_eddy_current fly_eddy_probe]
#*# reg_drive_current = 14
#*# calibrate =
#*# 	0.050000:4470598.656,0.090000:4467511.276,0.130000:4464474.452,
#*# 	0.170000:4461490.115,0.210000:4458590.913,0.250000:4455747.492,
#*# 	0.290000:4452967.518,0.330000:4450257.737,0.370000:4447583.067,
#*# 	0.410000:4444970.072,0.450000:4442441.857,0.490000:4439951.808,
#*# 	0.530000:4437476.706,0.570000:4435084.891,0.610000:4432743.943,
#*# 	0.650000:4430441.195,0.690000:4428173.476,0.730000:4425962.073,
#*# 	0.770000:4423781.298,0.810000:4421627.200,0.850000:4419503.870,
#*# 	0.890000:4417430.687,0.930000:4415391.180,0.970000:4413426.721,
#*# 	1.010000:4411490.920,1.050000:4409599.251,1.090000:4407742.005,
#*# 	1.130000:4405925.953,1.170000:4404142.679,1.210000:4402401.787,
#*# 	1.250000:4400685.398,1.290000:4399002.504,1.330000:4397328.924,
#*# 	1.370000:4395718.390,1.410000:4394110.112,1.450000:4392531.758,
#*# 	1.490000:4390992.772,1.530000:4389473.411,1.570000:4387971.151,
#*# 	1.610000:4386489.876,1.650000:4385033.548,1.690000:4383601.037,
#*# 	1.730000:4382178.253,1.770000:4380777.335,1.810000:4379393.309,
#*# 	1.850000:4378028.009,1.890000:4376678.151,1.930000:4375340.126,
#*# 	1.970000:4374035.614,2.010000:4372734.583,2.050000:4371449.900,
#*# 	2.090000:4370181.082,2.130000:4368927.795,2.170000:4367686.498,
#*# 	2.210000:4366459.107,2.250000:4365248.603,2.290000:4364055.544,
#*# 	2.330000:4362870.782,2.370000:4361692.350,2.410000:4360522.634,
#*# 	2.450000:4359365.540,2.490000:4358214.974,2.530000:4357081.739,
#*# 	2.570000:4355959.469,2.610000:4354855.195,2.650000:4353765.220,
#*# 	2.690000:4352691.466,2.730000:4351623.804,2.770000:4350570.565,
#*# 	2.810000:4349538.136,2.850000:4348516.241,2.890000:4347506.064,
#*# 	2.930000:4346510.693,2.970000:4345525.539,3.010000:4344550.110,
#*# 	3.050000:4343590.122,3.090000:4342638.248,3.130000:4341708.970,
#*# 	3.170000:4340790.249,3.210000:4339885.617,3.250000:4338996.137,
#*# 	3.290000:4338120.430,3.330000:4337259.996,3.370000:4336402.923,
#*# 	3.410000:4335563.016,3.450000:4334731.614,3.490000:4333908.635,
#*# 	3.530000:4333095.550,3.570000:4332291.121,3.610000:4331502.020,
#*# 	3.650000:4330719.298,3.690000:4329945.420,3.730000:4329189.605,
#*# 	3.770000:4328432.468,3.810000:4327694.309,3.850000:4326963.871,
#*# 	3.890000:4326250.827,3.930000:4325545.859,3.970000:4324847.472,
#*# 	4.010000:4324155.420,4.050000:4323478.174
#*# z_offset = 2.005
#*#
#*# [temperature_probe fly_eddy_probe]
#*# calibration_temp = 30.782714
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	-0.050835, -0.024917, -0.026590, -0.032607, -0.044402, -0.051151, -0.058480, -0.061893, -0.140488
#*# 	-0.020055, 0.016735, 0.017777, 0.004852, -0.005567, -0.009319, -0.013121, -0.014707, -0.101805
#*# 	-0.026605, 0.014420, 0.021117, -0.000644, -0.014276, -0.014469, -0.019314, -0.024796, -0.114963
#*# 	-0.034193, 0.000880, 0.005174, -0.006623, -0.013936, -0.014128, -0.019537, -0.025211, -0.116583
#*# 	-0.029435, 0.001966, 0.001833, -0.002534, -0.010794, -0.013312, -0.016899, -0.016676, -0.113445
#*# 	-0.026470, 0.003709, 0.005908, 0.003724, -0.002328, -0.005040, -0.009627, -0.008805, -0.109036
#*# 	-0.015328, 0.016839, 0.017821, 0.017453, 0.012574, 0.010800, 0.006712, 0.002951, -0.104927
#*# 	-0.001612, 0.030904, 0.033918, 0.032572, 0.029661, 0.030802, 0.027258, 0.023096, -0.088317
#*# 	-0.021315, 0.003401, 0.055043, 0.061727, 0.056183, 0.055465, 0.036931, -0.001390, -0.087170
#*# x_count = 9
#*# y_count = 9
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 10.0
#*# max_x = 170.0
#*# min_y = 10.0
#*# max_y = 170.0
